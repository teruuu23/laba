-- 1. Создание базы данных (с предварительным удалением)
DROP DATABASE IF EXISTS order_management;
CREATE DATABASE order_management;
USE order_management;



-- 2. Создание таблицы products
CREATE TABLE products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL
);

-- 3. Создание таблицы orders
CREATE TABLE orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    order_date DATE NOT NULL
);

-- 4. Создание таблицы order_items со связями
CREATE TABLE order_items (
    order_item_id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

-- 5. Добавление данных в products
INSERT INTO products (name, price) VALUES
('Ноутбук', 55000),
('Мышь', 800),
('Клавиатура', 1500),
('Монитор', 12000);

-- 6. Добавление данных в orders
INSERT INTO orders (order_date) VALUES
('2025-01-10'),
('2025-01-15'),
('2025-01-20');

-- 7. Добавление данных в order_items
INSERT INTO order_items (order_id, product_id, quantity, total_price) VALUES
(1, 1, 1, 55000),
(1, 2, 2, 1600),
(2, 4, 1, 12000),
(3, 3, 3, 4500);

-- 8. Запрос: список всех товаров
SELECT * FROM products;

-- 9. Запрос: позиции по заказу №1
SELECT 
    oi.order_item_id,
    p.name,
    oi.quantity,
    oi.total_price
FROM order_items oi
JOIN products p ON oi.product_id = p.id
WHERE oi.order_id = 1;

-- 10. Запрос: общая стоимость заказа №1
SELECT 
    order_id,
    SUM(total_price) AS total_order_price
FROM order_items
WHERE order_id = 1
GROUP BY order_id;

-- 11. Запрос: заказы за период с общей суммой
SELECT 
    o.order_id,
    o.order_date,
    SUM(oi.total_price) AS total_sum
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
WHERE o.order_date BETWEEN '2025-01-01' AND '2025-01-31'
GROUP BY o.order_id, o.order_date;

-- 12. Отчет: самые часто заказываемые товары за период
SELECT 
    p.name,
    SUM(oi.quantity) AS total_quantity
FROM order_items oi
JOIN products p ON p.id = oi.product_id
JOIN orders o ON o.order_id = oi.order_id
WHERE o.order_date BETWEEN '2025-01-01' AND '2025-01-31'
GROUP BY p.name
ORDER BY total_quantity DESC;

-- 13. Обновление цены товара
UPDATE products
SET price = 900
WHERE id = 2;

-- 14. Удаление позиции заказа
DELETE FROM order_items
WHERE order_item_id = 3;
